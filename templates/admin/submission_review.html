{% extends "base.html" %}

{% block title %}{{ _('Review Submission') }} - {{ super() }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">{{ _('Admin') }}</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('admin.submissions') }}">{{ _('Submissions') }}</a></li>
        <li class="breadcrumb-item active">{{ _('Review') }}</li>
    </ol>
</nav>

<h1 class="mb-4">{{ _('Review Submission') }}</h1>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header">
                <h4>{{ _('Submission Details') }}</h4>
            </div>
            <div class="card-body">
                <p><strong>{{ _('User') }}:</strong> {{ submission.user.username }}</p>
                <p><strong>{{ _('Challenge') }}:</strong> {{ submission.challenge.title }}</p>
                <p><strong>{{ _('Submitted At') }}:</strong> {{ submission.submitted_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                <p><strong>{{ _('Challenge Points') }}:</strong> {{ submission.challenge.points }}</p>
                
                <hr>
                
                <h5>{{ _('Answer Text') }}</h5>
                <div class="border p-3" style="background: var(--bg-tertiary); color: var(--text-primary);  border-radius: 5px">
                    {{ submission.answer_text or _('No text answer provided.') }}
                </div>
                
                {% if submission.files.count() > 0 %}
                    <hr>
                    <h5>{{ _('Uploaded Files') }}</h5>
                    <div class="row">
                        {% for file in submission.files %}
                            <div class="col-md-4 mb-3">
                                <img src="{{ url_for('uploaded_file', filename=file.filepath) }}" 
                                     class="img-fluid img-thumbnail" 
                                     alt="{{ file.filename }}">
                                <p class="small text-muted">{{ file.filename }}</p>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h4>{{ _('Challenge Description') }}</h4>
            </div>
            <div class="card-body">
                <div class="markdown-content" id="challenge-description"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4>{{ _('Review') }}</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        <label class="form-label">{{ _('Status') }}</label>
                        {{ form.status(class="form-select") }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ _('Points Awarded') }}</label>
                        {{ form.points_awarded(class="form-control", type="number") }}
                        <small class="text-muted">{{ _('Default points:') }} {{ submission.challenge.points }}</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">{{ _('Submit Review') }}</button>
                </form>
                
                <hr>
                
                <a href="{{ url_for('admin.submissions') }}" class="btn btn-secondary w-100">
                    {{ _('Back to Submissions') }}
                </a>
            </div>
        </div>
        
        {% if submission.reviewed_at %}
            <div class="card mt-3">
                <div class="card-header">
                    <h5>{{ _('Review History') }}</h5>
                </div>
                <div class="card-body">
                    <p><strong>{{ _('Reviewed By') }}:</strong> {{ submission.reviewed_by_name or (submission.reviewer.username if submission.reviewer else '-') }}</p>
                    <p><strong>{{ _('Reviewed At') }}:</strong> {{ submission.reviewed_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    <p><strong>{{ _('Points Awarded') }}:</strong> {{ submission.points_awarded }}</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Render challenge description
    const description = {{ submission.challenge.description|tojson }};
    document.getElementById('challenge-description').innerHTML = marked.parse(description);
</script>
{% endblock %}
