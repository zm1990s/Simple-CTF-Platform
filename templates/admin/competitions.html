{% extends "base.html" %}

{% block title %}{{ _('Manage Competitions') }} - {{ super() }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ _('Manage Competitions') }}</h1>
    <div>
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary me-2">
            <i class="bi bi-arrow-left"></i> {{ _('Back to Dashboard') }}
        </a>
        <a href="{{ url_for('admin.competitions_export_all') }}" class="btn btn-success me-2">
            <i class="bi bi-download"></i> {{ _('Export All') }}
        </a>
        <a href="{{ url_for('admin.competition_import') }}" class="btn btn-info me-2">
            <i class="bi bi-upload"></i> {{ _('Import') }}
        </a>
        <a href="{{ url_for('admin.competition_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> {{ _('New Competition') }}
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>{{ _('Name') }}</th>
                        <th>{{ _('Countdown') }}</th>
                        <th>{{ _('Status') }}</th>
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for competition in competitions %}
                        <tr>
                            <td>
                                {{ competition.name }}
                                </td>
                            <td>
                                {% if competition.countdown_minutes > 0 %}
                                    {% if competition.countdown_minutes >= 60 %}
                                        {{ (competition.countdown_minutes // 60)|int }}h {{ (competition.countdown_minutes % 60)|int }}m
                                    {% else %}
                                        {{ competition.countdown_minutes }}m
                                    {% endif %}
                                    {% set remaining = competition.get_remaining_time() %}
                                    {% if remaining is not none %}
                                        <br>
                                        <small class="text-success">
                                            <i class="bi bi-hourglass-split"></i>
                                            {% if remaining >= 3600 %}
                                                {{ (remaining // 3600)|int }}h {{ ((remaining % 3600) // 60)|int }}m {{ (remaining % 60)|int }}s {{ _('remaining') }}
                                            {% else %}
                                                {{ (remaining // 60)|int }}m {{ (remaining % 60)|int }}s {{ _('remaining') }}
                                            {% endif %}
                                        </small>
                                    {% elif competition.status in ['draft', 'stopped'] %}
                                        <br>
                                        <small class="text-warning">
                                            <i class="bi bi-info-circle"></i> {{ _('Click Start to begin countdown') }}
                                        </small>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">{{ _('No countdown') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if competition.status == 'draft' %}
                                    <span class="badge bg-secondary">{{ _('Draft') }}</span>
                                {% elif competition.status == 'running' %}
                                    <span class="badge bg-success">{{ _('Running') }}</span>
                                {% elif competition.status == 'paused' %}
                                    <span class="badge bg-warning text-dark">{{ _('Paused') }}</span>
                                {% elif competition.status == 'stopped' %}
                                    <span class="badge bg-danger">{{ _('Stopped') }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('admin.competition_edit', competition_id=competition.id) }}" 
                                       class="btn btn-sm btn-primary" 
                                       title="{{ _('Edit') }}">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    
                                    {% if competition.status in ['draft', 'stopped'] %}
                                    <form method="POST" action="{{ url_for('admin.competition_start', competition_id=competition.id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-success" title="{{ _('Start') }}">
                                            <i class="bi bi-play-fill"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    
                                    {% if competition.status in ['running', 'paused'] %}
                                    <form method="POST" action="{{ url_for('admin.competition_pause', competition_id=competition.id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-{{ 'success' if competition.status == 'paused' else 'warning' }}" 
                                                title="{{ _('Resume') if competition.status == 'paused' else _('Pause') }}">
                                            <i class="bi bi-{{ 'play-fill' if competition.status == 'paused' else 'pause-fill' }}"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    
                                    {% if competition.status != 'stopped' %}
                                    <form method="POST" action="{{ url_for('admin.competition_stop', competition_id=competition.id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" title="{{ _('Stop') }}">
                                            <i class="bi bi-stop-fill"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                                
                                <div class="btn-group ms-1" role="group">
                                    <a href="{{ url_for('admin.competition_export', competition_id=competition.id) }}" 
                                       class="btn btn-sm btn-success" 
                                       title="{{ _('Export') }}">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    
                                    <form method="POST" action="{{ url_for('admin.competition_duplicate', competition_id=competition.id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-info" title="{{ _('Duplicate') }}">
                                            <i class="bi bi-files"></i>
                                        </button>
                                    </form>
                                    
                                    <form method="POST" action="{{ url_for('admin.competition_reset', competition_id=competition.id) }}" 
                                          style="display:inline;" 
                                          onsubmit="return confirm('{{ _('This will delete all submissions for this competition. Are you sure?') }}');">
                                        <button type="submit" class="btn btn-sm btn-warning" title="{{ _('Reset') }}">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </form>
                                    
                                    <form method="POST" action="{{ url_for('admin.competition_delete', competition_id=competition.id) }}" 
                                          style="display:inline;" 
                                          onsubmit="return confirm('{{ _('Are you sure?') }}');">
                                        <button type="submit" class="btn btn-sm btn-secondary" title="{{ _('Delete') }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
