{% extends "base.html" %}

{% block title %}{{ competition.name }} - {{ super() }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h1 class="display-5 cyber-text" style="font-weight: 700; letter-spacing: 2px;">
            <i class="bi bi-trophy-fill"></i> {{ competition.name }}
        </h1>
        <div style="height: 2px; width: 150px; background: linear-gradient(90deg, var(--cyber-primary), transparent); margin-top: 10px;"></div>
    </div>
    <a href="{{ url_for('frontend.leaderboard', competition_id=competition.id) }}" class="btn btn-primary btn-lg">
        <i class="bi bi-bar-chart-fill"></i> {{ _('Leaderboard') }}
    </a>
</div>

<div class="alert" style="background: linear-gradient(135deg, rgba(0, 255, 65, 0.15), rgba(0, 170, 255, 0.15)); border: 2px solid var(--cyber-primary); border-radius: 10px;">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <strong style="color: var(--cyber-primary); font-size: 1.1rem;">
                <i class="bi bi-activity"></i> {{ _('Status') }}:
            </strong>
            {% if competition.status == 'running' %}
                <span class="badge bg-success text-glow ms-2" style="font-size: 1rem; padding: 0.5rem 1rem;">
                    <i class="bi bi-broadcast"></i> {{ _('Running') }}
                </span>
            {% elif competition.status == 'paused' %}
                <span class="badge bg-warning text-dark ms-2" style="font-size: 1rem; padding: 0.5rem 1rem;">
                    <i class="bi bi-pause-fill"></i> {{ _('Paused') }}
                </span>
            {% else %}
                <span class="badge bg-secondary ms-2" style="font-size: 1rem; padding: 0.5rem 1rem;">{{ competition.status }}</span>
            {% endif %}
        </div>
        
        {% if competition.countdown_minutes > 0 %}
            {% set remaining = competition.get_remaining_time() %}
            {% if remaining is not none and competition.is_running() %}
                <div class="text-end">
                    <strong style="color: var(--cyber-secondary); font-size: 1.1rem;">
                        <i class="bi bi-hourglass-split"></i> {{ _('Time Remaining') }}:
                    </strong>
                    <div class="badge bg-danger mt-2 countdown-display" style="font-size: 1.3rem; padding: 0.7rem 1.5rem; box-shadow: 0 0 20px rgba(255, 0, 110, 0.6);" data-remaining="{{ remaining }}">
                        <i class="bi bi-alarm-fill"></i>
                        <span id="countdown-text">{{ (remaining // 3600)|int }}h {{ ((remaining % 3600) // 60)|int }}m {{ (remaining % 60)|int }}s</span>
                    </div>
                </div>
            {% elif not competition.is_running() %}
                <div class="text-end">
                    <div class="alert alert-warning" style="display: inline-block; margin: 0; padding: 0.5rem 1rem;">
                        <i class="bi bi-info-circle"></i> {{ _('Countdown will start when competition begins') }}
                    </div>
                </div>
            {% endif %}
        {% endif %}
    </div>
</div>

{% if competition.description %}
    <div class="mb-5">
        <h4 style="color: var(--cyber-secondary); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1.5rem;">
            <i class="bi bi-info-circle-fill"></i> {{ _('Description') }}
        </h4>
        <div class="card" style="border: 1px solid rgba(0, 170, 255, 0.3); background: var(--bg-tertiary);">
            <div class="card-body markdown-content" style="color: var(--text-primary);" id="competition-description"></div>
        </div>
    </div>
{% endif %}

<h3 class="mb-4" style="color: var(--cyber-primary); text-transform: uppercase; letter-spacing: 2px;">
    <i class="bi bi-puzzle-fill"></i> {{ _('Challenges') }}
</h3>

{% if challenges %}
    <div class="row">
        {% for challenge in challenges %}
            <div class="col-md-6 mb-4">
                <div class="card challenge-card h-100" style="border: 2px solid rgba(0, 170, 255, 0.3);">
                    <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, rgba(0, 170, 255, 0.2), rgba(0, 255, 65, 0.1));">
                        <span style="font-weight: 700; color: var(--cyber-secondary);">
                            <i class="bi bi-flag-fill"></i> {{ challenge.title }}
                        </span>
                        <span class="badge bg-info" style="font-size: 1rem; padding: 0.5rem 0.8rem;">
                            {{ challenge.points }} pts
                        </span>
                    </div>
                    <div class="card-body">
                        {% if challenge.category %}
                            <p style="color: #888; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">
                                <i class="bi bi-tag-fill"></i> {{ _('Category') }}: <strong style="color: var(--cyber-secondary);">{{ challenge.category }}</strong>
                            </p>
                        {% endif %}
                        
                        {% if challenge.id in user_submissions %}
                            {% set submission = user_submissions[challenge.id] %}
                            <div class="mb-3">
                                {% if submission.status == 'approved' %}
                                    <span class="badge bg-success" style="font-size: 1rem; padding: 0.6rem 1rem;">
                                        <i class="bi bi-check-circle-fill"></i> {{ _('Solved') }}
                                    </span>
                                {% elif submission.status == 'rejected' %}
                                    <span class="badge bg-danger" style="font-size: 1rem; padding: 0.6rem 1rem;">
                                        <i class="bi bi-x-circle-fill"></i> {{ _('Rejected') }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning text-dark" style="font-size: 1rem; padding: 0.6rem 1rem;">
                                        <i class="bi bi-clock-fill"></i> {{ _('Pending Review') }}
                                    </span>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        <div class="mt-auto">
                            <a href="{{ url_for('frontend.challenge_detail', challenge_id=challenge.id) }}" class="btn btn-primary w-100">
                                <i class="bi bi-eye-fill"></i> {{ _('View Challenge') }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="alert alert-info text-center" style="background: rgba(0, 170, 255, 0.1); border: 2px solid var(--cyber-secondary); padding: 2rem;">
        <i class="bi bi-inbox" style="font-size: 3rem; color: var(--cyber-secondary);"></i>
        <h5 class="mt-3" style="color: var(--cyber-secondary);">{{ _('No challenges available for this competition.') }}</h5>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Render competition description as Markdown
    const descriptionElement = document.getElementById('competition-description');
    if (descriptionElement) {
        const markdownText = {{ competition.description|tojson|safe }};
        descriptionElement.innerHTML = marked.parse(markdownText);
    }
    
    // Real-time countdown update
    const countdownDisplay = document.querySelector('.countdown-display');
    if (countdownDisplay) {
        let remainingSeconds = parseInt(countdownDisplay.dataset.remaining);
        
        function updateCountdown() {
            if (remainingSeconds <= 0) {
                document.getElementById('countdown-text').textContent = '0h 0m 0s';
                // Optionally reload page when countdown reaches 0
                setTimeout(() => location.reload(), 1000);
                return;
            }
            
            const hours = Math.floor(remainingSeconds / 3600);
            const minutes = Math.floor((remainingSeconds % 3600) / 60);
            const seconds = remainingSeconds % 60;
            
            document.getElementById('countdown-text').textContent = 
                `${hours}h ${minutes}m ${seconds}s`;
            
            remainingSeconds--;
        }
        
        // Update every second
        setInterval(updateCountdown, 1000);
    }
</script>
{% endblock %}
